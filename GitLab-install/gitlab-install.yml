---
-
  become: true
  hosts: all
  become_method: sudo
  become_user: root
  tasks:
  - name: Disabled AutoUpdate
    copy:
      dest: "/etc/apt/apt.conf.d/20auto-upgrades"
      content: |
        APT::Periodic::Update-Package-Lists "0";
        APT::Periodic::Unattended-Upgrade "0";

  - name: Update APT
    apt:
      update_cache: yes

  - name: Install packeges
    apt:
      name:
        - policycoreutils

  - name: Selinux Disabled
    lineinfile: dest=/etc/selinux/config
                regexp='^SELINUX='
                insertbefore=BOF
                line='SELINUX=disabled'

  - name: UFW disabled
    community.general.ufw:
      state: disabled

  - name: Unconditionally reboot the machine with all defaults
    ansible.builtin.reboot:

-
  become: true
  hosts: gitlab
  become_method: sudo
  become_user: root
  tasks:
  - name: Install postfix
    apt:
      name:
        - postfix
        - curl

  - name: Add gitlab repositories
    shell: curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash

  - name: Install gitlab-ce
    apt:
      name:
        - gitlab-ce

  - name: Edit /etc/gitlab/gitlab.rb
    lineinfile: dest=/etc/gitlab/gitlab.rb
                regexp='^external_url'
                insertbefore=BOF
                line="external_url 'http://gitlab.my'"

  - name: GitLab reconfigure
    shell: gitlab-ctl reconfigure

# cat /etc/gitlab/initial_root_password | grep Password:
